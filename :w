import { writeFile } from './utils';
import prettier, { Options as PrettierOptions } from 'prettier';

export interface WriterProps {
  imports: string;
  writePartitions: Record<string, WritePartition>;
}

export type WritePartition = Map<string, string>;

export class Writer {
  private writeContent: Map<string, string> = new Map();

  constructor(private props: WriterProps) {}

  public concatImportToWriteContent = () => {
    const {
      writeContent,
      props: { imports },
    } = this;

    writeContent.forEach((value, key) =>
      this.props.writeContent.set(
        key,
        imports.concat('\n'.repeat(3)).concat(value),
      ),
    );

    return this;
  };

  public formatWriteContent = (
    prettierOptions: PrettierOptions = { parser: 'babel' },
  ) => {
    const { writePartitions } = this.props;

    writePartitions.a.forEach((value, key) => {
      const formattedContent = prettier.format(value, prettierOptions);

      writePartitions.a.set(key, formattedContent);
    });

    return this;
  };

  public async write() {
    const { writePartitions } = this.props;

    const writingPromises: Promise<void>[] = [];

    writePartitions.a.forEach((value, key) =>
      writingPromises.push(
        writeFile(key, value, {
          encoding: 'utf-8',
        }),
      ),
    );

    try {
      await Promise.all(writingPromises);
    } catch (err) {
      console.error(err);
    }
  }
}
